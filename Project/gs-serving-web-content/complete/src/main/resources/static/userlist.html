<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Coffee Shop - Danh sách người dùng</title>
		<style>
			:root{--coffee-900:#3e2723;--coffee-700:#5d4037;--accent:#c59d5f;--cream:#fff8e1}
			*{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--coffee-900);background:linear-gradient(180deg,#efebe9,#fff 30%)}
			header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:linear-gradient(135deg,#5d4037,#3e2723);color:#fff}
			header .brand{display:flex;align-items:center;gap:10px}
			header .logo{width:36px;height:36px;display:grid;place-items:center;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:8px}
			main{max-width:1000px;margin:20px auto;padding:0 16px}
			.toolbar{display:flex;justify-content:space-between;align-items:center;margin:10px 0 14px}
			.btn{border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
			.btn.primary{background:var(--accent);color:#1d140f}
			.card{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:16px;box-shadow:0 8px 22px rgba(62,39,35,.10);overflow:hidden}
			table{width:100%;border-collapse:collapse}
			th,td{padding:12px 14px;border-bottom:1px solid #eee;text-align:left}
			th{background:linear-gradient(180deg,#fff,var(--cream));font-size:14px}
			tr:hover td{background:#faf7f2}
			a.link{color:#5d4037;text-decoration:none}
			a.link:hover{text-decoration:underline}
			.actions a{margin-right:10px}
			.search{display:flex;gap:8px}
			.search input{padding:10px 12px;border:1px solid #d4cfcf;border-radius:10px;min-width:220px}
		</style>
	</head>
	<body>
		<header>
			<div class="brand"><div class="logo">☕</div><div>Coffee Shop - Quản lý người dùng</div></div>
			<nav>
				<a class="btn ghost" id="backDashboard" th:href="@{/dashboard}" href="dashboard.html">Quay về Dashboard</a>
			</nav>
		</header>
		<main>
			<div class="toolbar">
				<div class="search">
					<form th:action="@{/userlist}" method="get" style="display:flex;gap:8px">
						<input type="text" name="q" placeholder="Tìm tên/email..." th:value="${param.q}" />
						<button class="btn" type="submit">Tìm</button>
					</form>
				</div>
					<a id="addUserBtn" class="btn primary" th:href="@{/userlist/add}" href="adduser.html">+ Thêm người dùng</a>
			</div>

			<div class="card">
				<table>
					<thead>
						<tr>
							<th>#</th>
							<th>Tên</th>
							<th>Username</th>
							<th>Email</th>
							<th>Hành động</th>
						</tr>
					</thead>
					<tbody id="usersTbody">
						<!-- Client-side rendered rows will be injected here from localStorage.users; server-side Thymeleaf will still work when rendered by server -->
						<tr id="noUsersRow"><td colspan="5" style="text-align:center;padding:18px">Chưa có người dùng.</td></tr>
					</tbody>
				</table>
			</div>
		</main>
		<script>
			(function(){
				const tbody = document.getElementById('usersTbody');
				const noRow = document.getElementById('noUsersRow');

				function loadUsers(){
					try{
						const raw = localStorage.getItem('users');
						const users = raw ? JSON.parse(raw) : [];
						render(users);
					}catch(e){ console.error('loadUsers', e); render([]); }
				}

				function render(users){
					// clear existing client-rendered rows (keep noUsersRow as fallback)
					Array.from(tbody.querySelectorAll('tr.client-row')).forEach(r => r.remove());
					if(!users || users.length === 0){ noRow.style.display = 'table-row'; return; }
					noRow.style.display = 'none';
					users.forEach(function(u, idx){
						const tr = document.createElement('tr');
						tr.className = 'client-row';
						tr.innerHTML = '<td>' + (idx+1) + '</td>' +
							'<td>' + escapeHtml(u.name || '') + '</td>' +
							'<td>' + escapeHtml(u.username || u.phoneNumber || '') + '</td>' +
							'<td>' + escapeHtml(u.email || '') + '</td>' +
							'<td class="actions">' +
								'<a class="link" href="#" data-id="' + (u.id||'') + '" data-action="edit">Sửa</a> ' +
								'<a class="link" href="#" data-id="' + (u.id||'') + '" data-action="delete">Xóa</a>' +
							'</td>';
						tbody.appendChild(tr);
					});
				}

				function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]; }); }

				// delegate clicks for edit/delete
				tbody.addEventListener('click', function(ev){
					const a = ev.target.closest('a[data-action]');
					if(!a) return;
					ev.preventDefault();
					const id = a.getAttribute('data-id');
					const action = a.getAttribute('data-action');
					if(action === 'delete'){
						if(!confirm('Xóa người dùng này?')) return;
						try{
							const raw = localStorage.getItem('users');
							const users = raw ? JSON.parse(raw) : [];
							const filtered = users.filter(u => (u.id || u.userId || '') !== id);
							localStorage.setItem('users', JSON.stringify(filtered));
							loadUsers();
						}catch(e){ console.error(e); alert('Lỗi khi xóa'); }
					}else if(action === 'edit'){
						// no client-side edit form yet; navigate to adduser (could be extended)
						window.location.href = 'adduser.html';
					}
				});

				// load on start
				loadUsers();

				// wire back to dashboard link if present
				const back = document.getElementById('backDashboard');
				if(back){ back.addEventListener('click', function(e){ e.preventDefault(); try{ fetch('/dashboard', {method:'HEAD', cache:'no-store'}).then(function(res){ if(res && (res.status===200||res.status===204)) location.href = '/dashboard'; else location.href = this.getAttribute('href')||'dashboard.html'; }.bind(this)).catch(function(){ location.href = this.getAttribute('href')||'dashboard.html'; }.bind(this)); }catch(err){ location.href = this.getAttribute('href')||'dashboard.html'; } }); }
			})();
		</script>
	</body>
	</html>

