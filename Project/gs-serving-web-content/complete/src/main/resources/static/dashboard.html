<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Coffee Shop - Dashboard</title>
    <style>
        :root{
            --coffee-900:#3e2723;
            --coffee-800:#4b332f;
            --coffee-700:#5d4037;
            --coffee-500:#6d4c41;
            --coffee-300:#a78274;
            --accent:#c59d5f;
            --accent-rgb:197,157,95;
            --bg:#f4efec;
            --success:#2e7d32;
            --warn:#c27d33;
            --danger:#d84343;
            --info:#1d6fa5;
        }
        *{box-sizing:border-box;font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif}
        body{
            margin:0;
            background:
              radial-gradient(900px 520px at 100% 0,rgba(var(--accent-rgb),.22),transparent 70%),
              linear-gradient(180deg,#f0e9e5,#ffffff 55%);
            color:var(--coffee-900);
            min-height:100vh;
            display:flex;
            flex-direction:column;
        }
        header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:18px 30px;
            background:linear-gradient(135deg,var(--coffee-700),var(--coffee-900));
            color:#fff;
            position:sticky;
            top:0;
            z-index:10;
            box-shadow:0 6px 16px -6px rgba(62,39,35,.5);
        }
        .brand{display:flex;align-items:center;gap:14px;}
        .logo{
            width:46px;height:46px;
            display:grid;place-items:center;
            background:rgba(255,255,255,.15);
            border:1px solid rgba(255,255,255,.25);
            border-radius:14px;
            font-size:22px;
            backdrop-filter:blur(4px);
        }
        nav a{
            color:#fff;
            text-decoration:none;
            font-size:14px;
            font-weight:500;
            margin-left:20px;
            position:relative;
            letter-spacing:.4px;
        }
        nav a:after{
            content:"";
            position:absolute;
            left:0;bottom:-4px;height:2px;width:0;
            background:linear-gradient(90deg,var(--accent),#f0d094);
            transition:.35s;
        }
        nav a:hover:after{width:100%;}
        main{
            width:100%;
            max-width:1380px;
            margin:36px auto 70px;
            padding:0 40px;
            flex:1;
            display:flex;
            flex-direction:column;
            gap:34px;
        }
        h1{
            margin:0;
            font-size:32px;
            letter-spacing:.6px;
            font-weight:600;
            background:linear-gradient(90deg,var(--coffee-900),var(--coffee-700));
            -webkit-background-clip:text;
            color:transparent;
        }
        .subtitle{
            margin:6px 0 0;
            font-size:14px;
            color:#6d5a53;
            letter-spacing:.3px;
        }
        .kpi-grid{
            display:grid;
            gap:22px;
            grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
        }
        .kpi{
            position:relative;
            background:#fff;
            border:1px solid rgba(62,39,35,.12);
            border-radius:22px;
            padding:18px 18px 16px;
            display:flex;
            flex-direction:column;
            gap:8px;
            min-height:120px;
            box-shadow:0 14px 34px -14px rgba(62,39,35,.28),0 6px 18px -10px rgba(0,0,0,.12);
            overflow:hidden;
        }
        .kpi:before{
            content:"";
            position:absolute;
            inset:0;
            background:
              radial-gradient(circle at 75% 15%,rgba(var(--accent-rgb),.16),transparent 55%);
            opacity:.55;
            pointer-events:none;
        }
        .kpi small{
            font-size:11px;
            font-weight:600;
            letter-spacing:.7px;
            text-transform:uppercase;
            color:#725b53;
        }
        .kpi h2{
            margin:0;
            font-size:26px;
            line-height:1.15;
            font-weight:600;
            color:var(--coffee-900);
            display:flex;
            align-items:center;
            gap:6px;
            flex-wrap:wrap;
        }
        .delta{
            font-size:11px;
            font-weight:600;
            padding:4px 8px;
            border-radius:14px;
            background:rgba(46,125,50,.12);
            color:var(--success);
            letter-spacing:.4px;
        }
        .delta.down{
            background:rgba(216,67,67,.12);
            color:var(--danger);
        }
        .spark{
            margin-top:auto;
            height:34px;
            display:flex;
            gap:4px;
            align-items:flex-end;
        }
        .spark span{
            flex:1;
            border-radius:6px 6px 2px 2px;
            background:linear-gradient(180deg,var(--accent),#e4bd7d);
            min-width:4px;
            position:relative;
            animation:fadeIn .6s ease;
        }
        .spark span:after{
            content:attr(data-val);
            position:absolute;
            top:-20px;
            left:50%;
            translate:-50% 0;
            font-size:9px;
            font-weight:600;
            color:#70584f;
            opacity:0;
            transition:.25s;
            pointer-events:none;
            letter-spacing:.3px;
        }
        .spark span:hover:after{opacity:1; top:-26px;}
        @keyframes fadeIn {from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)}}

        .layout-two{
            display:grid;
            gap:30px;
            grid-template-columns:2.2fr 1.4fr;
            align-items:start;
        }
        .card{
            background:#fff;
            border:1px solid rgba(62,39,35,.12);
            border-radius:32px;
            padding:30px 30px 24px;
            display:flex;
            flex-direction:column;
            gap:22px;
            box-shadow:0 18px 46px -14px rgba(62,39,35,.32),0 6px 18px -8px rgba(0,0,0,.18);
            overflow:hidden;
            position:relative;
        }
        .card h3{
            margin:0;
            font-size:19px;
            letter-spacing:.5px;
            font-weight:600;
            display:flex;
            align-items:center;
            gap:10px;
            color:var(--coffee-900);
        }
        .table-wrap{
            overflow:auto;
            scrollbar-width:thin;
            border-radius:18px;
        }
        table{
            width:100%;
            border-collapse:collapse;
            font-size:13.5px;
            line-height:1.4;
            min-width:600px;
        }
        thead th{
            text-align:left;
            padding:12px 16px;
            font-weight:600;
            font-size:11px;
            letter-spacing:.7px;
            text-transform:uppercase;
            background:linear-gradient(180deg,#fff,#f8f5f4);
            color:#6a5852;
            position:sticky;
            top:0;
            border-bottom:1px solid #eee;
        }
        tbody td{
            padding:11px 16px;
            border-bottom:1px solid #f1ecea;
            vertical-align:middle;
        }
        tbody tr:last-child td{border-bottom:none;}
        tbody tr{transition:.22s}
        tbody tr:hover{background:#fdfbf9;}
        .code{
            font-weight:600;
            color:var(--coffee-900);
            letter-spacing:.5px;
        }
        .status{
            display:inline-flex;
            align-items:center;
            gap:6px;
            font-size:10px;
            font-weight:600;
            padding:6px 10px 5px;
            background:#efe7e3;
            border-radius:20px;
            letter-spacing:.5px;
        }
        .status.paid{background:rgba(46,125,50,.12);color:var(--success);border:1px solid rgba(46,125,50,.35)}
        .status.pending{background:rgba(194,125,51,.14);color:#925520;border:1px solid rgba(194,125,51,.4)}
        .status.cancel{background:rgba(216,67,67,.12);color:var(--danger);border:1px solid rgba(216,67,67,.35)}

        .mini-link{
            text-decoration:none;
            font-size:12px;
            font-weight:600;
            letter-spacing:.4px;
            padding:8px 14px;
            border-radius:14px;
            background:#ede5e1;
            color:var(--coffee-800);
            transition:.25s;
        }
        .mini-link:hover{background:#e3d9d4}

        .progress-block{
            display:grid;
            gap:12px;
        }
        .progress-label{
            display:flex;
            justify-content:space-between;
            font-size:12px;
            font-weight:600;
            letter-spacing:.5px;
            text-transform:uppercase;
            color:#6c5851;
        }
        .progress{
            position:relative;
            height:18px;
            background:#efe6e2;
            border-radius:40px;
            overflow:hidden;
        }
        .progress span{
            position:absolute;
            inset:0;
            width:0;
            background:linear-gradient(90deg,var(--accent),#e4bd7d);
            border-radius:inherit;
            animation:grow 1.2s ease forwards;
        }
        @keyframes grow {from{width:0} to{width:var(--w)}}

        .top-products{
            display:grid;
            gap:16px;
        }
        .top-item{
            display:flex;
            align-items:center;
            gap:14px;
            padding:10px 14px;
            background:#faf7f5;
            border:1px solid #efe4df;
            border-radius:16px;
            position:relative;
            overflow:hidden;
        }
        .top-item:before{
            content:attr(data-rank);
            position:absolute;
            top:8px;right:10px;
            font-size:11px;
            font-weight:600;
            color:#7d6158;
            opacity:.35;
            letter-spacing:.5px;
        }
        .avatar{
            width:46px;height:46px;
            border-radius:14px;
            background:linear-gradient(135deg,#f3edea,#e5d8d2);
            display:grid;place-items:center;
            font-size:20px;
            color:#705549;
            font-weight:600;
        }
        .top-info{
            display:flex;
            flex-direction:column;
            gap:4px;
            flex:1;
        }
        .top-info strong{font-size:14px;letter-spacing:.4px}
        .badge{
            font-size:10px;
            font-weight:600;
            letter-spacing:.5px;
            padding:4px 8px 3px;
            border-radius:14px;
            background:#ede4df;
            color:#725b53;
            display:inline-block;
        }
        .trend-up{color:var(--success);font-weight:600}
        .trend-down{color:var(--danger);font-weight:600}
        .empty{
            text-align:center;
            padding:30px 10px;
            font-size:13px;
            color:#806a62;
        }
        footer{
            text-align:center;
            padding:50px 0 30px;
            font-size:12px;
            color:#78655d;
        }
        @media (max-width:1280px){
            .layout-two{grid-template-columns:1.8fr 1.2fr}
        }
        @media (max-width:1040px){
            main{padding:0 30px}
            .layout-two{grid-template-columns:1fr}
        }
        @media (max-width:720px){
            h1{font-size:28px}
            .kpi-grid{grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
            .card{border-radius:28px;padding:26px 24px 22px}
            main{padding:0 22px}
        }
        @media (max-width:520px){
            header{padding:16px 20px}
            main{margin:28px auto 60px;}
            .kpi{border-radius:18px;padding:16px 16px 14px}
        }
    </style>
</head>
<body>
<header>
    <div class="brand">
        <div class="logo">☕</div>
        <div style="display:flex;flex-direction:column;line-height:1.2">
            <strong style="font-size:17px;letter-spacing:.5px">Coffee Shop</strong>
            <span style="font-size:12px;opacity:.8;letter-spacing:.4px">Dashboard</span>
        </div>
    </div>
    <nav>
        <a id="navDashboard" th:href="@{/dashboard}" href="dashboard.html" aria-current="page">Dashboard</a>
        <a id="navUsers" th:href="@{/users}" href="userlist.html">Người dùng</a>
        <a id="navProducts" th:href="@{/products}" href="productlist.html">Sản phẩm</a>
        <a id="navLogout" th:href="@{/logout}" href="home.html">Đăng xuất</a>
    </nav>
</header>

<main>
    <div>
        <h1>Tổng quan</h1>
        <p class="subtitle" th:text="'Dữ liệu cập nhật lúc ' + ${#dates.format(#dates.createNow(),'HH:mm')} + ' • Hôm nay ' + ${#dates.format(#dates.createNow(),'dd/MM/yyyy')}"></p>
    </div>

    <!-- KPIs -->
    <div class="kpi-grid">
        <div class="kpi">
            <small>Doanh thu hôm nay</small>
            <h2>
                <span th:text="${#numbers.formatDecimal(kpi.todayRevenue,1,'COMMA',2,'POINT')} + ' đ'">0 đ</span>
                <span class="delta" th:classappend="${kpi.todayRevenueChange < 0} ? ' down'" 
                      th:text="${kpi.todayRevenueChange >= 0 ? '+' : ''} + ${kpi.todayRevenueChange} + '%'">+0%</span>
            </h2>
            <div class="spark" th:if="${todayRevenueTrend != null}">
                <span th:each="v : ${todayRevenueTrend}" th:style="'height:' + (${v} == 0 ? 4 : ${v}) + 'px'"
                      th:attr="data-val=${v}"></span>
            </div>
        </div>
        <div class="kpi">
            <small>Doanh thu tháng</small>
            <h2>
                <span th:text="${#numbers.formatDecimal(kpi.monthRevenue,1,'COMMA',0,'POINT')} + ' đ'">0</span>
                <span class="delta" th:classappend="${kpi.monthRevenueChange < 0} ? ' down'"
                      th:text="${kpi.monthRevenueChange >= 0 ? '+' : ''} + ${kpi.monthRevenueChange} + '%'">+0%</span>
            </h2>
            <div class="progress-block">
                <div class="progress" th:with="pct=${kpi.monthRevenueTarget > 0 ? (kpi.monthRevenue / kpi.monthRevenueTarget) * 100 : 0}"
                     th:style="--w:${pct} + '%'">
                    <span th:style="'--w:' + ${pct} + '%'"></span>
                </div>
                <div class="progress-label">
                    <span th:text="'Mục tiêu: ' + ${#numbers.formatDecimal(kpi.monthRevenueTarget,1,'COMMA',0,'POINT')} + ' đ'">Mục tiêu</span>
                    <span th:text="${pct} + '%'">0%</span>
                </div>
            </div>
        </div>
        <div class="kpi">
            <small>Đơn hàng hôm nay</small>
            <h2>
                <span th:text="${kpi.todayOrders}">0</span>
                <span class="delta" th:classappend="${kpi.todayOrdersChange < 0} ? ' down'"
                      th:text="${kpi.todayOrdersChange >=0 ? '+' : ''} + ${kpi.todayOrdersChange} + '%'">+0%</span>
            </h2>
            <div class="spark" th:if="${ordersTrend != null}">
                <span th:each="v : ${ordersTrend}" th:style="'height:' + (${v} == 0 ? 4 : ${v}) + 'px'"
                      th:attr="data-val=${v}"></span>
            </div>
        </div>
        <div class="kpi">
            <small>Khách hàng mới</small>
            <h2>
                <span th:text="${kpi.newCustomers}">0</span>
                <span class="delta" th:classappend="${kpi.newCustomersChange < 0} ? ' down'"
                      th:text="${kpi.newCustomersChange >=0 ? '+' : ''} + ${kpi.newCustomersChange} + '%'">+0%</span>
            </h2>
            <div class="spark" th:if="${newCustomersTrend != null}">
                <span th:each="v : ${newCustomersTrend}" th:style="'height:' + (${v} == 0 ? 4 : ${v}) + 'px'"
                      th:attr="data-val=${v}"></span>
            </div>
        </div>
        <div class="kpi">
            <small>Giá trị TB / đơn</small>
            <h2>
                <span th:text="${#numbers.formatDecimal(kpi.averageOrderValue,1,'COMMA',0,'POINT')} + ' đ'">0 đ</span>
                <span class="delta" th:classappend="${kpi.aovChange < 0} ? ' down'"
                      th:text="${kpi.aovChange >=0 ? '+' : ''} + ${kpi.aovChange} + '%'">+0%</span>
            </h2>
        </div>
        <div class="kpi">
            <small>Đơn đang chờ</small>
            <h2>
                <span th:text="${kpi.pendingOrders}">0</span>
                <span class="delta" th:classappend="${kpi.pendingOrdersChange < 0} ? ' down'"
                      th:text="${kpi.pendingOrdersChange >=0 ? '+' : ''} + ${kpi.pendingOrdersChange} + '%'">+0%</span>
            </h2>
        </div>
        <div class="kpi">
            <small>Sản phẩm bán chạy</small>
            <h2 style="font-size:18px" th:text="${kpi.topProductName} ?: '---'">---</h2>
            <div style="font-size:12px;color:#775f56;font-weight:600;letter-spacing:.4px"
                 th:text="'SL: ' + ${kpi.topProductSales}">SL: 0</div>
        </div>
        <div class="kpi">
            <small>Tỉ lệ hủy</small>
            <h2>
                <span th:text="${kpi.cancelRate} + '%'">0%</span>
                <span class="delta down" th:if="${kpi.cancelRateChange > 0}"
                      th:text="'+' + ${kpi.cancelRateChange} + '%'">+0%</span>
                <span class="delta" th:if="${kpi.cancelRateChange <= 0}"
                      th:text="${kpi.cancelRateChange} + '%'">0%</span>
            </h2>
        </div>
    </div>

    <div class="layout-two">
        <!-- Recent Orders -->
        <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:14px">
                <h3>Đơn hàng gần đây</h3>
                <a th:href="@{/orders}" class="mini-link">Xem tất cả</a>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                    <tr>
                        <th>Mã</th>
                        <th>Khách hàng</th>
                        <th>Thời gian</th>
                        <th>Tổng</th>
                        <th>Trạng thái</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="o : ${recentOrders}">
                        <td class="code" th:text="${o.code}">ODR001</td>
                        <td>
                            <strong th:text="${o.customerName}">Khách</strong><br/>
                            <span style="font-size:11px;color:#7d6760" th:text="${o.customerPhone}">SĐT</span>
                        </td>
                        <td th:text="${#dates.format(o.createdAt,'dd/MM HH:mm')}">--</td>
                        <td th:text="${#numbers.formatDecimal(o.totalAmount,1,'COMMA',0,'POINT')} + ' đ'">0 đ</td>
                        <td>
                            <span class="status"
                                  th:classappend="${o.status=='PAID'} ? ' paid' : (o.status=='PENDING' ? ' pending' : ' cancel')"
                                  th:text="${o.status}">
                            </span>
                        </td>
                        <td>
                            <a th:href="@{'/orders/' + ${o.id}}" class="mini-link" style="padding:6px 10px;font-size:11px">Chi tiết</a>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(recentOrders)}">
                        <td colspan="6" class="empty">Chưa có đơn hàng.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Top Products & Revenue progress -->
        <div style="display:grid;gap:30px">
            <div class="card" style="padding:26px 26px 22px">
                <h3>Sản phẩm bán chạy</h3>
                <div class="top-products" th:if="${topProducts != null}">
                    <div class="top-item" th:each="p, st : ${topProducts}" th:data-rank="${st.count}">
                        <div class="avatar" th:text="${#strings.substring(p.name,0,1)}">C</div>
                        <div class="top-info">
                            <strong th:text="${p.name}">Tên</strong>
                            <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
                                <span class="badge" th:text="'SL: ' + ${p.totalQuantity}">SL:0</span>
                                <span class="badge" style="background:#e2d9d4" th:text="${#numbers.formatDecimal(p.totalRevenue,1,'COMMA',0,'POINT')} + ' đ'">0 đ</span>
                                <span th:if="${p.changePercent != null}"
                                      th:classappend="${p.changePercent >=0 ? 'trend-up' : 'trend-down'}"
                                      th:text="${p.changePercent >=0 ? '▲ ' + p.changePercent +'%' : '▼ ' + (p.changePercent * -1) + '%'}"></span>
                            </div>
                        </div>
                    </div>
                    <div th:if="${#lists.isEmpty(topProducts)}" class="empty" style="padding:18px 10px">Chưa có dữ liệu.</div>
                </div>
            </div>
            <div class="card" style="padding:26px 26px 24px">
                <h3>Tình hình doanh thu tuần</h3>
                <div class="spark" style="height:60px" th:if="${weekRevenueTrend != null}">
                    <span th:each="v : ${weekRevenueTrend}"
                          th:style="'height:' + (${v} == 0 ? 6 : ${v}) + 'px;background:linear-gradient(180deg,var(--coffee-500),var(--coffee-700))'"
                          th:attr="data-val=${v}"></span>
                </div>
                <div th:if="${weekRevenueTrend == null}" class="empty" style="padding:16px 0 4px">Không có dữ liệu.</div>
                <div class="progress-block" style="margin-top:10px">
                    <div class="progress" th:with="pct=${kpi.weekRevenueTarget > 0 ? (kpi.weekRevenue / kpi.weekRevenueTarget) * 100 : 0}"
                         th:style="--w:${pct} + '%'">
                        <span th:style="'--w:' + ${pct} + '%'"></span>
                    </div>
                    <div class="progress-label">
                        <span th:text="'Tuần: ' + ${#numbers.formatDecimal(kpi.weekRevenue,1,'COMMA',0,'POINT')} + ' / ' + ${#numbers.formatDecimal(kpi.weekRevenueTarget,1,'COMMA',0,'POINT')} + ' đ'">0</span>
                        <span th:text="${pct} + '%'"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

</main>

<footer>&copy; <span th:text="${#dates.format(#dates.createNow(),'yyyy')}"></span> Coffee Shop – Dashboard</footer>
<script>
    (function(){
        // helper: try server route then fallback to href
        function navigatePreferServer(path, fallback){
            try{
                fetch(path, {method:'HEAD', cache:'no-store'})
                    .then(function(res){ if(res && (res.status===200 || res.status===204)) location.href = path; else location.href = fallback; })
                    .catch(function(){ location.href = fallback; });
            }catch(e){ location.href = fallback; }
        }

        const navUsers = document.getElementById('navUsers');
        const navProducts = document.getElementById('navProducts');
        const navDashboard = document.getElementById('navDashboard');
        const navLogout = document.getElementById('navLogout');

        if(navUsers){ navUsers.addEventListener('click', function(e){ e.preventDefault(); navigatePreferServer('/users', this.getAttribute('href') || 'userlist.html'); }); }
        if(navProducts){ navProducts.addEventListener('click', function(e){ e.preventDefault(); navigatePreferServer('/products', this.getAttribute('href') || 'productlist.html'); }); }
        if(navDashboard){ navDashboard.addEventListener('click', function(e){ e.preventDefault(); navigatePreferServer('/dashboard', this.getAttribute('href') || 'dashboard.html'); }); }
        if(navLogout){ navLogout.addEventListener('click', function(e){ e.preventDefault(); try{ sessionStorage.removeItem('currentUser'); }catch(_){}; navigatePreferServer('/logout', this.getAttribute('href') || 'home.html'); }); }
    })();
</script>
</body>
</html>